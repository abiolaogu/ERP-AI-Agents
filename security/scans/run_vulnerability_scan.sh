#!/bin/bash
# Comprehensive Vulnerability Scanning for AI Agents Platform
# Scans Docker images, dependencies, code, and configuration

set -e

SCAN_DIR="./scan-results"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_FILE="${SCAN_DIR}/vulnerability_report_${TIMESTAMP}.txt"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}AI Agents Platform - Vulnerability Scan${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# Create scan results directory
mkdir -p $SCAN_DIR

# Initialize report
echo "AI Agents Platform - Vulnerability Scan Report" > $REPORT_FILE
echo "Scan Date: $(date)" >> $REPORT_FILE
echo "=============================================" >> $REPORT_FILE
echo "" >> $REPORT_FILE

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to log results
log_result() {
    echo "$1" | tee -a $REPORT_FILE
}

# 1. Docker Image Scanning
echo -e "${YELLOW}[1/7] Scanning Docker Images...${NC}"
if command_exists trivy; then
    log_result "=== Docker Image Scan (Trivy) ==="

    # Scan a sample agent image
    SAMPLE_IMAGE="ai-agents/business_plan_agent_009:latest"

    if docker images | grep -q "business_plan_agent_009"; then
        trivy image --severity HIGH,CRITICAL $SAMPLE_IMAGE >> $REPORT_FILE 2>&1
        log_result "Docker image scan completed"
    else
        log_result "Sample image not found. Build images first."
    fi
else
    log_result "Trivy not installed. Install with: brew install trivy (Mac) or apt install trivy (Linux)"
fi
echo ""

# 2. Python Dependency Scanning
echo -e "${YELLOW}[2/7] Scanning Python Dependencies...${NC}"
if command_exists safety; then
    log_result "=== Python Dependencies Scan (Safety) ==="

    # Scan each requirements file
    find . -name "requirements.txt" -type f | while read req_file; do
        log_result "Scanning: $req_file"
        safety check --file $req_file >> $REPORT_FILE 2>&1 || true
    done

    log_result "Dependency scan completed"
else
    log_result "Safety not installed. Install with: pip install safety"
fi
echo ""

# 3. Code Security Scanning
echo -e "${YELLOW}[3/7] Scanning Code for Security Issues...${NC}"
if command_exists bandit; then
    log_result "=== Code Security Scan (Bandit) ==="

    # Scan Python code
    bandit -r generated-agents/ -f txt -o ${SCAN_DIR}/bandit_report_${TIMESTAMP}.txt 2>&1 || true
    cat ${SCAN_DIR}/bandit_report_${TIMESTAMP}.txt >> $REPORT_FILE

    log_result "Code security scan completed"
else
    log_result "Bandit not installed. Install with: pip install bandit"
fi
echo ""

# 4. Secrets Scanning
echo -e "${YELLOW}[4/7] Scanning for Exposed Secrets...${NC}"
if command_exists gitleaks; then
    log_result "=== Secrets Scan (Gitleaks) ==="

    gitleaks detect --source . --report-path ${SCAN_DIR}/gitleaks_report_${TIMESTAMP}.json 2>&1 || true

    if [ -f "${SCAN_DIR}/gitleaks_report_${TIMESTAMP}.json" ]; then
        cat ${SCAN_DIR}/gitleaks_report_${TIMESTAMP}.json >> $REPORT_FILE
    fi

    log_result "Secrets scan completed"
else
    log_result "Gitleaks not installed. Install with: brew install gitleaks"
fi
echo ""

# 5. Container Security Scanning
echo -e "${YELLOW}[5/7] Scanning Container Configuration...${NC}"
if command_exists docker-bench-security; then
    log_result "=== Container Security Scan ==="

    docker-bench-security >> ${SCAN_DIR}/docker_bench_${TIMESTAMP}.txt 2>&1 || true
    cat ${SCAN_DIR}/docker_bench_${TIMESTAMP}.txt >> $REPORT_FILE

    log_result "Container security scan completed"
else
    log_result "Docker Bench Security not installed"
fi
echo ""

# 6. Kubernetes Security Scanning
echo -e "${YELLOW}[6/7] Scanning Kubernetes Manifests...${NC}"
if command_exists kubesec; then
    log_result "=== Kubernetes Security Scan (Kubesec) ==="

    # Scan Kubernetes manifests
    find infrastructure/kubernetes -name "*.yaml" -type f | while read manifest; do
        log_result "Scanning: $manifest"
        kubesec scan $manifest >> $REPORT_FILE 2>&1 || true
    done

    log_result "Kubernetes manifest scan completed"
else
    log_result "Kubesec not installed. Install with: brew install kubesec"
fi
echo ""

# 7. OWASP Dependency Check
echo -e "${YELLOW}[7/7] Running OWASP Dependency Check...${NC}"
if command_exists dependency-check; then
    log_result "=== OWASP Dependency Check ==="

    dependency-check.sh \
        --scan . \
        --format HTML \
        --out ${SCAN_DIR}/owasp_report_${TIMESTAMP}.html \
        --suppression suppression.xml 2>&1 >> $REPORT_FILE || true

    log_result "OWASP dependency check completed"
else
    log_result "OWASP Dependency Check not installed"
fi
echo ""

# Generate Summary
echo -e "${YELLOW}Generating Summary...${NC}"
log_result ""
log_result "============================================="
log_result "SCAN SUMMARY"
log_result "============================================="
log_result ""

# Count issues by severity
HIGH_COUNT=$(grep -i "HIGH" $REPORT_FILE | wc -l || echo "0")
CRITICAL_COUNT=$(grep -i "CRITICAL" $REPORT_FILE | wc -l || echo "0")
MEDIUM_COUNT=$(grep -i "MEDIUM" $REPORT_FILE | wc -l || echo "0")

log_result "Critical Issues: $CRITICAL_COUNT"
log_result "High Issues: $HIGH_COUNT"
log_result "Medium Issues: $MEDIUM_COUNT"
log_result ""

if [ $CRITICAL_COUNT -gt 0 ]; then
    echo -e "${RED}⚠ CRITICAL vulnerabilities found!${NC}"
    log_result "ACTION REQUIRED: Address critical vulnerabilities immediately"
elif [ $HIGH_COUNT -gt 0 ]; then
    echo -e "${YELLOW}⚠ HIGH severity vulnerabilities found${NC}"
    log_result "RECOMMENDATION: Address high severity vulnerabilities before production deployment"
else
    echo -e "${GREEN}✓ No critical or high severity vulnerabilities found${NC}"
    log_result "RESULT: Scan passed with no critical issues"
fi

echo ""
log_result "Full report saved to: $REPORT_FILE"
log_result "Scan completed at: $(date)"

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Scan Complete!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo "View full report: cat $REPORT_FILE"
echo ""

# Exit with error if critical vulnerabilities found
if [ $CRITICAL_COUNT -gt 0 ]; then
    exit 1
fi

exit 0
