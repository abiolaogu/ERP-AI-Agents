---
# Redis Cluster for high-performance caching
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
  namespace: ai-agents
spec:
  serviceName: redis-cluster
  replicas: 6
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - redis-cluster
            topologyKey: kubernetes.io/hostname
      containers:
      - name: redis
        image: redis:7.2-alpine
        ports:
        - containerPort: 6379
          name: client
        - containerPort: 16379
          name: gossip
        command:
        - redis-server
        args:
        - /conf/redis.conf
        - --cluster-enabled
        - "yes"
        - --cluster-config-file
        - /data/nodes.conf
        - --cluster-node-timeout
        - "5000"
        - --appendonly
        - "yes"
        - --maxmemory
        - "4gb"
        - --maxmemory-policy
        - allkeys-lru
        - --save
        - ""
        - --tcp-backlog
        - "511"
        - --timeout
        - "0"
        - --tcp-keepalive
        - "300"
        - --hz
        - "10"
        volumeMounts:
        - name: conf
          mountPath: /conf
        - name: data
          mountPath: /data
        resources:
          requests:
            cpu: 500m
            memory: 4Gi
          limits:
            cpu: 2000m
            memory: 8Gi
        livenessProbe:
          tcpSocket:
            port: 6379
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: conf
        configMap:
          name: redis-cluster-config
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi

---
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster
  namespace: ai-agents
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - port: 6379
    targetPort: 6379
    name: client
  - port: 16379
    targetPort: 16379
    name: gossip
  selector:
    app: redis-cluster

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-cluster-config
  namespace: ai-agents
data:
  redis.conf: |
    # Redis Cluster Configuration
    cluster-enabled yes
    cluster-require-full-coverage no
    cluster-node-timeout 5000
    cluster-migration-barrier 1
    cluster-replica-validity-factor 10

    # Memory Management
    maxmemory 4gb
    maxmemory-policy allkeys-lru
    maxmemory-samples 5

    # Persistence (disabled for cache-only)
    save ""
    appendonly no

    # Performance Tuning
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300
    hz 10
    dynamic-hz yes

    # Slow Log
    slowlog-log-slower-than 10000
    slowlog-max-len 128

    # Latency Monitoring
    latency-monitor-threshold 100

    # Client Output Buffer Limits
    client-output-buffer-limit normal 0 0 0
    client-output-buffer-limit replica 256mb 64mb 60
    client-output-buffer-limit pubsub 32mb 8mb 60

---
# Redis Sentinel for high availability
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-sentinel
  namespace: ai-agents
spec:
  replicas: 3
  selector:
    matchLabels:
      app: redis-sentinel
  template:
    metadata:
      labels:
        app: redis-sentinel
    spec:
      containers:
      - name: sentinel
        image: redis:7.2-alpine
        ports:
        - containerPort: 26379
          name: sentinel
        command:
        - redis-sentinel
        args:
        - /conf/sentinel.conf
        volumeMounts:
        - name: conf
          mountPath: /conf
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      volumes:
      - name: conf
        configMap:
          name: redis-sentinel-config

---
apiVersion: v1
kind: Service
metadata:
  name: redis-sentinel
  namespace: ai-agents
spec:
  type: ClusterIP
  ports:
  - port: 26379
    targetPort: 26379
    name: sentinel
  selector:
    app: redis-sentinel

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-sentinel-config
  namespace: ai-agents
data:
  sentinel.conf: |
    port 26379
    sentinel monitor mymaster redis-cluster-0.redis-cluster 6379 2
    sentinel down-after-milliseconds mymaster 5000
    sentinel parallel-syncs mymaster 1
    sentinel failover-timeout mymaster 10000

---
# KeyDB (Redis alternative with multi-threading) for hot cache
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keydb-hot-cache
  namespace: ai-agents
spec:
  replicas: 3
  selector:
    matchLabels:
      app: keydb-hot-cache
  template:
    metadata:
      labels:
        app: keydb-hot-cache
    spec:
      containers:
      - name: keydb
        image: eqalpha/keydb:latest
        ports:
        - containerPort: 6379
        command:
        - keydb-server
        args:
        - --server-threads
        - "4"
        - --maxmemory
        - "2gb"
        - --maxmemory-policy
        - allkeys-lfu
        - --save
        - ""
        - --appendonly
        - "no"
        - --hz
        - "100"
        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
          limits:
            cpu: 4000m
            memory: 4Gi

---
apiVersion: v1
kind: Service
metadata:
  name: keydb-hot-cache
  namespace: ai-agents
spec:
  type: ClusterIP
  ports:
  - port: 6379
    targetPort: 6379
  selector:
    app: keydb-hot-cache

---
# Hazelcast for distributed L2 cache
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: hazelcast
  namespace: ai-agents
spec:
  serviceName: hazelcast
  replicas: 3
  selector:
    matchLabels:
      app: hazelcast
  template:
    metadata:
      labels:
        app: hazelcast
    spec:
      containers:
      - name: hazelcast
        image: hazelcast/hazelcast:5.3
        ports:
        - containerPort: 5701
          name: hazelcast
        env:
        - name: JAVA_OPTS
          value: "-Xms2g -Xmx4g -XX:+UseG1GC"
        - name: HZ_CLUSTERNAME
          value: "ai-agents"
        resources:
          requests:
            cpu: 500m
            memory: 4Gi
          limits:
            cpu: 2000m
            memory: 8Gi
        livenessProbe:
          httpGet:
            path: /hazelcast/health/node-state
            port: 5701
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /hazelcast/health/ready
            port: 5701
          initialDelaySeconds: 30
          periodSeconds: 10

---
apiVersion: v1
kind: Service
metadata:
  name: hazelcast
  namespace: ai-agents
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - port: 5701
    targetPort: 5701
  selector:
    app: hazelcast

---
# Memcached for session storage
apiVersion: apps/v1
kind: Deployment
metadata:
  name: memcached
  namespace: ai-agents
spec:
  replicas: 3
  selector:
    matchLabels:
      app: memcached
  template:
    metadata:
      labels:
        app: memcached
    spec:
      containers:
      - name: memcached
        image: memcached:1.6-alpine
        ports:
        - containerPort: 11211
        command:
        - memcached
        args:
        - -m
        - "1024"
        - -c
        - "1024"
        - -t
        - "4"
        - -v
        resources:
          requests:
            cpu: 250m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 2Gi

---
apiVersion: v1
kind: Service
metadata:
  name: memcached
  namespace: ai-agents
spec:
  type: ClusterIP
  ports:
  - port: 11211
    targetPort: 11211
  selector:
    app: memcached
