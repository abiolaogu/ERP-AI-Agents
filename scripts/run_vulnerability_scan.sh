#!/bin/bash
# scripts/run_vulnerability_scan.sh

# Exit immediately if a command exits with a non-zero status.
set -e

# Install trivy if not already installed
if ! command -v trivy &> /dev/null
then
    echo "Trivy not found, installing..."
    sudo apt-get update
    sudo apt-get install -y wget apt-transport-https gnupg lsb-release
    wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
    echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
    sudo apt-get update
    sudo apt-get install -y trivy
fi

echo "Building Docker images for scanning..."
# Build the images using the docker-compose file, but don't start the services
sudo docker compose build

echo "Scanning orchestration-engine image..."
# In a real CI/CD pipeline, you might fail the build on high/critical vulnerabilities
sudo trivy image app-orchestration-engine:latest --exit-code 0 --no-progress

echo "Scanning seo-agent image..."
sudo trivy image app-seo-agent:latest --exit-code 0 --no-progress

echo "Scanning lead-scoring-agent image..."
sudo trivy image app-lead-scoring-agent:latest --exit-code 0 --no-progress

echo "Vulnerability scan complete."
